language: minimal
cache:
  directories:
    - $HOME/.jabba/
matrix:
  include:
    - name: "Linux JDK11 - unit"
      os: linux
      dist: xenial
      env:
        - JDK="openjdk@1.11"
        - TRAVIS_DIST_NAME="xenial"
# Vary OS        
    - name: "MacOS JDK11 - unit"
      os: osx
      osx_image: xcode10.1
      env:
        - JDK="openjdk@1.11"
        - TRAVIS_DIST_NAME="osx10"
    - name: "Windows JDK11 - unit"
      os: windows
      env:
        - JDK="openjdk@1.11"
        - TRAVIS_DIST_NAME="win"
    - name: "Linux JDK8 - unit"
      os: linux
      dist: xenial
      env:
        - JDK="adopt@1.8"
        - TRAVIS_DIST_NAME="xenial"
    - name: "Linux JDK13 - unit"
      os: linux
      dist: xenial
      env:
        - JDK="openjdk@1.13"
        - TRAVIS_DIST_NAME="xenial"

        
env:
  global:
    # Convenience variables for shortening commands
    - GRAVIS_REPO="https://github.com/DanySK/Gravis-CI.git"
    - GRAVIS="$HOME/gravis"        
        
before_install:
  # Check out the script set
  - travis_retry git clone --depth 1 $GRAVIS_REPO $GRAVIS
  - source $GRAVIS/install-jdk
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then export HOMEBREW_NO_AUTO_UPDATE=1; travis_wait brew update >/dev/null; brew install ant; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then sudo apt-get install ant -y; fi
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then choco install ant -y; fi
install:
  - WD=$PWD
  - cd ..
  - git clone https://github.com/Funz/funz-profile
  - cd $WD

before_script:
# Install R anyway
  - >  
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then 
    echo "deb https://cloud.r-project.org/bin/linux/ubuntu xenial-cran35/" | sudo tee -a /etc/apt/sources.list;
    sudo apt-get update -qq --allow-unauthenticated; 
    sudo apt-get install r-base --allow-unauthenticated -y; 
    sudo apt-get install libglu1-mesa-dev libglu1-mesa-dev libfreetype6-dev --allow-unauthenticated -y; 
    R --version;
    fi
  - >
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then 
    wd=$PWD; 
    cd /usr/local/Homebrew/Library/Taps/homebrew/homebrew-core; git reset --hard c3a244c627e; git checkout -b r-3.6.3;
    cd $wd;
    brew reinstall r;
    R --version;
    fi
  - >
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then
    choco install -y r --version 3.6;
    export PATH=$PATH:"C:\Program Files\R\R-3.6.0\bin";
    R.exe --version;
    fi
# Install Python if needed
  - >
    if [[ "$NO_TEST_PYTHON" != "1" ]]; then 
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then 
    sudo apt-get install python3-numpy python3-pip --allow-unauthenticated ; 
    sudo pip3 install py4j==0.10.8.1; 
    fi; 
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    brew install python3; 
    pip3 install numpy; 
    pip3 install py4j==0.10.8.1;  
    fi; 
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then 
    choco install -y python;
    fi; 
    fi
# Install rJava if needed
  - >
    if [[ "$NO_TEST_R" != "1" ]]; then 
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then 
    sudo apt-get install libpcre2-8-0 libpcre2-dev --allow-unauthenticated -y;
    sudo ln -s /usr/lib/jvm/default-java $JAVA_HOME; 
    sudo R CMD javareconf JAVA_HOME=$JAVA_HOME; 
    sudo R -e "install.packages('rJava',repos = 'https://cloud.r-project.org')"; 
    fi; 
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then 
    export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_112.jdk/Contents/Home;
    R CMD javareconf JAVA_HOME=$JAVA_HOME; 
    R -e "install.packages('rJava',repos = 'https://cloud.r-project.org')"; 
    fi; 
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then 
    R.exe CMD javareconf JAVA_HOME=$JAVA_HOME; 
    R.exe -e "install.packages('rJava',repos = 'https://cloud.r-project.org')"; 
    fi;
    fi
    
script: 
  - ant test

after_success:
# Coverage for reference conf
  - >
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then 
    if [[ "$JDK" == "openjdk@1.11" ]]; then 
    ant coverage;
    bash <(curl -s https://codecov.io/bash);
    fi; fi

before_deploy:
  - ant clean dist
  - cd dist; zip -r ../funz-core.zip ./*
  - cd ..
  
deploy:
  provider: releases
  name: funz-core
  api_key:
    secure: E6RhJ6bvS8g9UZiCJUh31jqAJ0p6M1JMVqUrV1wKDbn7ua0oiDvM33e39vRhIUaTtsPcCVV9qzC7D4oU+VXhDa6/r3ZRrTBEwsOJ8A5y7DB8V2reKZ+4MweiJVGbj6Wky0bU/bbZQtJec+hSxOqFXbbnhgMC9H2fQRnB6JaPfMXIhpDfHpcKxbdHDowaoP40Oidwf0YCAb9EeEuCKehuJ4yR/lksCLYUYRKrNOEYv5E0cRmOoVYYF6abFclzOW3TmbvZC0qt/i3+zirJejKZkXA6PIQ4hrMSijDSfdSWufio6s7eEHpfe3VJdXc4IwwlFV+SzHonOLa1wq1FLQwUtrPx3JybSD70s+OVqvp+uQxyCnCyZoY7pWxy6jApc5wTf7YnjspLLUf20tuwe3tKR3/x+y99gnBO7W4dmRyVM5vaC/jxm97NIntjxbEQpBkaT+I4RYEnAtn46fAaOFG7W9u9c48PLOX+/JYG2qFXDBW1tRzygHeLMW2VgMc3RVjzxTFvVAPJKOunBzmSwHQM43OP6V8el6zjPeExlHl8y2r+6Uv6UNkTygzXzZWf7VKnjY4KMGhuascGz8kLaPrLSWYSCtN7XBqwYJXh/EprSbwd3wGESNlVvi7CLGA+t/LVd6YuekxLgV7UszaEeDnca38EPPzPQchP+SkpuQ7ZYxs=
  file_glob: true
  file: funz-core*.zip
  on:
    tags: true
    branch: master
  skip_cleanup: true
  overwrite: true
